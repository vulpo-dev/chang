{
  "db_name": "PostgreSQL",
  "query": "\r\nwith insert_error as (\r\n\tinsert into chang.task_error(task_id, error)\r\n\tselect $1 as task_id\r\n\t     , $2 as error\r\n\treturning task_id\r\n), insert_history as (\r\n\tinsert into chang.task_history(task_id, from_state, to_state)\r\n\tselect id as task_id\r\n\t     , 'running'::chang.tasks_state as from_state \r\n\t     , case\r\n\t          when attempt < max_attempts\r\n\t          then 'retryable'::chang.tasks_state\r\n\t          else 'discarded'::chang.tasks_state\r\n\t       end as to_state\r\n\t  from chang.tasks\r\n\t where id in (select * from insert_error)\r\n\treturning task_id, to_state\r\n)\r\nupdate chang.tasks\r\n   set state = insert_history.to_state\r\n  from insert_history\r\n where id = insert_history.task_id\r\n",
  "describe": {
    "columns": [],
    "parameters": {
      "Left": [
        "Uuid",
        "Text"
      ]
    },
    "nullable": []
  },
  "hash": "b9850757378dfa1f9cd33de3241190b125cc93cb0470ab0e4f96a8e90e786259"
}
